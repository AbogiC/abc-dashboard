RewriteEngine On
RewriteBase /backend/

# Handle preflight requests
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ $1 [R=200,L]

# API routing
RewriteRule ^api/auth/(.*)$ api/auth.php?action=$1 [QSA,L]
RewriteRule ^api/projects/stats$ api/projects.php [QSA,L]
RewriteRule ^api/projects/([0-9]+)$ api/projects.php?id=$1 [QSA,L]
RewriteRule ^api/projects$ api/projects.php [QSA,L]
RewriteRule ^api/calendar/(upcoming|range)$ api/calendar.php?endpoint=$1 [QSA,L]
RewriteRule ^api/calendar/([0-9]+)$ api/calendar.php?id=$1 [QSA,L]
RewriteRule ^api/calendar$ api/calendar.php [QSA,L]
RewriteRule ^api/stats$ api/stats.php [QSA,L]
RewriteRule ^api/users/([0-9]+)$ api/users.php?id=$1 [QSA,L]
RewriteRule ^api/users$ api/users.php [QSA,L]

# Deny access to sensitive files
<FilesMatch "\.(php|inc|config|sql)$">
    Order Deny,Allow
    Deny from all
</FilesMatch>

# Allow access to specific API files
<FilesMatch "^(auth|projects|calendar|stats|users)\.php$">
    Order Allow,Deny
    Allow from all
</FilesMatch>